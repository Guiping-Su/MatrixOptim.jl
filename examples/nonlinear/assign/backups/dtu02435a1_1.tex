\documentclass[fleqn,10pt]{wlscirep}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

% Table with Three Lines
\usepackage{booktabs}
\usepackage{longtable}

% Ensure Floats Stay inside the Section
\usepackage[section]{placeins}

% Julia definition (c) 2014 Jubobs
\usepackage[T1]{fontenc}
\usepackage{beramono}
\usepackage{listings}
\usepackage[usenames,dvipsnames]{xcolor}
\lstdefinelanguage{Julia}%
  {morekeywords={abstract, break, case, catch, const, continue, do, else, elseif, %
      end, export, false, for, function, immutable, import, importall, if, in, %
      macro, module, otherwise, quote, return, switch, true, try, type, typealias, %
      using,while, solve, @constraint, @variable, sum, Model, zeros, readxl, openxl, cat},%
   sensitive=true,%
   % alsoother={$},%
   morecomment=[l]{\#},%
   morecomment=[f][\color{forestgreen(web)}][0]{\#},%
   morestring=[s]{"}{"},%
   morestring=[m]{'}{'},%
}[keywords,comments,strings]%

\usepackage{color}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\definecolor{forestgreen(web)}{rgb}{0.13, 0.55, 0.13}
\lstset{%
    language         = Julia,
    basicstyle       = \ttfamily,
    keywordstyle     = \bfseries\color{blue},
    stringstyle      = \color{magenta},
    commentstyle     = \color{forestgreen(web)},
    showstringspaces = false,
    backgroundcolor  = \color{backcolour}, 
    numbers          = left,                    
    numbersep        = 5pt,
    basicstyle       = \footnotesize
}

% Remove the abstract
\usepackage{abstract}
\renewcommand{\abstractname}{}    % clear the title
\renewcommand{\absnamepos}{empty} % originally center

% Allow environments like 'align' to display in multiple pages
\allowdisplaybreaks

% ------------------------------------------------------------
% ------------------------------------------------------------
% ------------------------------------------------------------
\begin{document}

\flushbottom
{\noindent \LARGE \textbf{DTU02435 Decision making under Uncertainty, Assignment 1}}

{\noindent \large \textbf{Edward J. Xu (Jie Xu), s181238, DTU Management}}

{\noindent \large \textbf{March 4th, 2019}}

\section{Task 1}

Formulate an explicit mathematical program for the above mentioned data to optimize the number of buildings per type while maximizing the return.
\begin{align}
    \max \quad& 200,000 \, x_1 + 240,000 \, x_2 + 300,000 \, x_3 \\
    \text{s.t.} \quad& 800 \, x_1 + 1000 \, x_2 + 1200 \, x_3 \leq 100,000 \\
    & x_1, x_2, x_3 \geq 0 \\
    & x_1, x_2, x_3 \in \mathbb{Z}
\end{align}

Extend your model with the following requirement: If you build semi-detached houses, then there need to be at least 30 of them.
\begin{align}
    \max \quad& 200,000 \, x_1 + 240,000 \, x_2 + 300,000 \, x_3 \\
    \text{s.t.} \quad& 800 \, x_1 + 1000 \, x_2 + 1200 \, x_3 \leq 100,000 \\
    & 30 \, y_1 \leq x_2 \leq \epsilon_1 \, y_1 \\
    & x_1, x_2, x_3 \geq 0 \\
    & x_1, x_2, x_3 \in \mathbb{Z} \\
    & y_1 \in \{0, 1 \} \\
    & \epsilon_1 = \frac{100,000}{1000} \quad \text{(large enough)}
\end{align}

Extend your model with the following requirement: If there are more than 150 households, you also have to support the opening of a new primary school with 1,000,000 EUR which lowers your return.
\begin{align}
    \max \quad& 200,000 \, x_1 + 240,000 \, x_2 + 300,000 \, x_3 - 1,000,000 \, y_2 \\
    \text{s.t.} \quad& 800 \, x_1 + 1000 \, x_2 + 1200 \, x_3 \leq 100,000 \\
    & 30 \, y_1 \leq x_2 \leq \epsilon_1 \, y_1 \\
    & 150 y_2 < x_1 + 2 \, x_2 + 4 \, x_3 \leq 150 + \epsilon_2 \, y_2 \\
    & x_1, x_2, x_3 \geq 0 \\
    & x_1, x_2, x_3 \in \mathbb{Z} \\
    & y_1, y_2 \in \{0, 1 \} \\
    & \epsilon_1 = \frac{100,000}{1000} \quad \text{(large enough)} \\
    & \epsilon_2 = 100,000,000 \quad \text{(large enough)}
\end{align}

Extend your model to consider the costs for infrastructure: For each single family house you have to consider 10,000 EUR, while the infrastructure costs for semi-detached houses and apartment buildings are 12,000 EUR and 14,000 EUR, respectively. However, the infrastructure cost will be at least 1,500,000 EUR, no matter how many houses are built. (In other words: The infrastructure costs are the maximum of house-based sum and 1,500,000 EUR).
\begin{align}
    \max \quad& 200,000 \, x_1 + 240,000 \, x_2 + 300,000 \, x_3 - 1,000,000 \, y_2 + p \\
    \text{s.t.} \quad& 800 \, x_1 + 1000 \, x_2 + 1200 \, x_3 \leq 100,000 \\
    & 30 \, y_1 \leq x_2 \leq \epsilon_1 \, y_1 \\
    & 150 \, y_2 < x_1 + 2 \, x_2 + 4 \, x_3 \leq 150 + \epsilon_2 \, y_2 \\
    & p \leq - 1,500,000 \\
    & p \leq - 10,000 \, x_1 - 12,000 \, x_2 - 14,000 \, x_3 \\
    & x_1, x_2, x_3 \geq 0 \\
    & x_1, x_2, x_3 \in \mathbb{Z} \\
    & y_1, y_2 \in \{0, 1 \} \\
    & \epsilon_1 = \frac{100,000}{1000} \quad \text{(large enough)} \\
    & \epsilon_2 = 100,000,000 \quad \text{(large enough)}
\end{align}

\section{Task 2: Primal-Dual Transformation}

\begin{align}
    \min \quad& - 4 \, x_1 + 3 \, x_2 + 0 \, x_3 - 1 \, x_4 + 0 \, x_5 \\
    \text{s.t.} \quad& \begin{array}{rrrrrl}
        5 \, x_1 &- 6 \, x_2 &- 3 \, x_3 &+ 1 \, x_4 &- 1 \, x_5 &= 7  \\
         & + 3 \, x_2 & + 5 \, x_3 & & - 2 \, x_5 &\leq 4  \\
        8 \, x_1 & &- 4 \, x_3 &+ 9 \, x_4 &+ 1 \, x_5 &\geq - 8  \\
        1 \, x_1 & & & &+ 3 \, x_5 &\leq 20
    \end{array} \\
    \quad & x_1 \geq 0 \\
    \quad & x_2, x_3, x_4 \leq 0 \\
    \quad & x_5 \in \mathbb{R}
\end{align}

\begin{align}
    \max \quad& 7 \,  y_1 + 4 \,  y_2 - 8 \,  y_3 + 20 \,  y_4 \\
    \text{s.t.} \quad& \begin{array}{rrrrl}
        5 \,  y_1 & &+ 8 \,  y_3 &+ 1 \,  y_4 &\geq - 4 \\
        - 6 \, y_1 &+ 3 \,  y_2 & & & \leq 3 \\
        - 3 \,  y_1 &+ 5 \, y_2 &- 4 \,  y_3 & & \leq 0  \\
        1 \,  y_1 & & + 9 \, y_3 & & \leq - 1 \\
        - 1 \,  y_1 & -2 \, y_2 &+ 1 \, y_3 &+ 3 \,  y_4 & = 0
    \end{array} \\
    \quad & y_3 \geq 0 \\
    \quad & y_2,  y_4 \leq 0 \\
    \quad & y_1 \in \mathbb{R}
\end{align}

\section{Task 3: General Questions}

\subsection{Explain the common decision variable structure of a two-stage program.}

First-stage decision variables are taken before the uncertainty is revealed, which are also called here-and-now decision variables. Most of them are integer variables, regrading the resources that the decision maker can have. Second-stage decision variables can be taken after the uncertainty is revealed, which are also called wait-and-see or recourse decisions. There are usually many real number variables among second-stage decision variables, regarding what to do with resources from the first stage.

\subsection{What is the advantage of stochastic programming compared to a deterministic optimization?}

There are two deterministic optimization methods to treat the problems solved by stochastic programming. One is called optimization with wait-and-see approach (WS), and the other one is called optimization with expected value (EEV). WS optimization is not possible in practice, because decisions must be made a priori. We can only get a hypothetical maximum value for reference. EEV method doesn't use use of information about uncertainty, which can cause some deviation in first-stage decisions, because the recourse decisions can be different in different scenarios. Stochastic programming uses all available information of uncertainty by including scenarios in the model to get the optimal expected value for the scenarios, and apply first-stage solution to all scenarios and recourse decision after uncertainty is resolved.

\subsection{Which are the more important decisions in a two-stage stochastic program: here-and-now decisions or wait-and-see decision? Justify your answer. (In other words: Which decisions are we more interested in when we solve a two-stage stochastic program)}

I think they are first-stage decisions. Because we are interested in the decisions that we must make right now. Second-stage decisions are like operation decisions. Only with practical first-stage decisions can we have the feasible domain for all kinds of possible situations. The second-stage objective values are references for decisions in the first stage. With different strategies or altitudes, decision makers can apply different weight for scenarios to help make desired decision in the first stage.

\section{Task 4: Modelling a two-stage stochastic program}

\subsection{Task 4, Question 1}

The mathematical model for two-stochastic programming of mixed integer linear problem is shown below:
{
\begin{align}
    \min \quad& \sum_{S} \pi_{s} \times \left[\sum_{T} \left(\sum_{L} \sum_{F} p_{l/d}^{s, t}(f) \times c_{l/d}(f) + \sum_{L/d} \sum_{L/d} p_{l/d}^{s, t}(l') \times c_{l/d}(l') + \right. \right. \\
    & \quad \left. \left. \sum_{L} \sum_{K} q_{l/d}^{s, t}(k) \times c_{l}(k) + \sum_{K} \sum_{T} 100,000 \, x_{k}^{s, t} \right) \right] + \sum_{L} y_l \times OPEN_l \\
    \text{s.t.} \quad& \sum_{F} p_{l}^{s, t}(f) + \sum_{L/d} p_{l}^{s, t}(l') \leq HC_{l} \times y_1 \quad \forall s, l, t \quad \text{(Handling Capacity of every $l$)} \\
    \quad& \sum_{F} p_{d}^{s, t}(f) + \sum_{L} p_{d}^{s, t}(l) \leq HC_{d} \quad \forall s, t \quad \text{(Handling Capacity of $d$)} \\
    & h_{l}^{s, t} = h_{l}^{s, t-1} +\sum_{F} p_{l}^{s, t}(f) + \sum_{L/d} p_{l}^{s, t}(l') - \sum_{K} q_{l}^{s, t}(k) - \sum_{L/d} q_{l}^{s, t}(l') \leq SC_{l} \times y_1 \quad \forall s, l, t \quad \text{(Storage Capacity)} \\
    & h_{d}^{s, t} = h_{d}^{s, t-1} + \sum_{F} p_{d}^{s, t}(f) + \sum_{L} p_{d}^{s, t}(l) - \sum_{K} q_{d}^{s, t}(k) - \sum_{L} q_{d}^{s, t}(l) \leq SC_{d} \quad \forall s, t \quad \text{(Storage Capacity of $d$)} \\
    & h_{l}^{s, t} + \sum_{K} q_{l}^{s, t}(k) + \sum_{L/d} q_{l}^{s, t}(l') \leq \sum_{F} p_{l}^{s, t}(f) + \sum_{L/d} p_{l}^{s, t}(l') + h_{l}^{s, t-1} \quad \forall s, l, t \quad \text{(Output $\leq$ Input + Storage)} \\
    & h_{d}^{s, t} + \sum_{K} q_{d}^{s, t}(k) + \sum_{L} q_{d}^{s, t}(l) \leq \sum_{F} p_{d}^{s, t}(f) + \sum_{L} p_{d}^{s, t}(l) + h_{d}^{s, t-1} \quad \forall s, t \quad \text{(Output $\leq$ Input + Storage in $d$)} \\
    & h_{l/d}^{s, t=0} = 0 \quad \forall s, l \text{ and  } d \quad \text{(Initial Storage = 0 of every $l$)} \\
    & q_{l}^{s, t}(l') = p_{l'}^{s, t}(l) \quad \forall u, l, s, t \quad \text{(Exchange Equal)} \\
    & 0 \leq \sum_{L} p_{f}^{s, t}(l) \leq SL_{f}^{s, t} \quad \forall f, s, t \quad \text{(Supply Limited)} \\
    & x_{k}^{s, t} \geq K_{k}^{s, t} - \sum_{L} q_{k}^{s, t}(l) \quad \forall k, s, t \quad \text{(At least make up to meet demand)} \\
    & x_{k}^{s, t} \geq 0 \quad \forall k, s, t \quad \text{(At least make up 0)} \\
    & y_l \in \{0, 1\} \quad \forall l \in \{1, 2, 3, 4, 5, 6\} \\
    & p_{l}^{s, t}(f), q_{l}^{s, t}(k) \geq 0 \quad \forall f, l, k, s, t
\end{align}
}%

There are 6 kinds of decision variables, as revealed in tab.\ref{tab:1}:
\begin{table}[ht]
    \centering
    \begin{tabular}{l l l l}
        \hline
        \\[-1em]
        Variable & Explain & Stage & Value Ranges \\
        \\[-1em]
        \hline
        \\[-1em]
        $y_l$ & whether open the $l$ location or not & first & ${0, 1}$ \\
        \\[-1em]
        $p_{l/d}^{s, t}(f)$ & input from forest $f$ to location $l(d)$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $p_{l/d}^{s, t}(l')$ & input from location $l'(d)$ to location $l(d)$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $q_{l}^{s, t}(k)$ & output from location $l(d)$ to customer $k$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $q_{l/d}^{s, t}(l')$ & output from location $l(d)$ to location $l'(d)$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $x_{k}^{s, t}$ & supplement bought to meet customer $k$'s demand & second & $\mathbb{R}_{\geq 0} \cap (\geq K_{k}^{s, t} - \sum_{L} q_{k}^{s, t}(l)) $ \\
        \\[-1em]
        $h_{l}^{s, t}$ & storage in location $l$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0} \cap (\leq SC_{l} \times y_1)$ \\
        \\[-1em]
        \hline
    \end{tabular}
    \caption{Categories of Decision Variables and Their Attributes}
    \label{tab:1}
\end{table}
\FloatBarrier

There are 5 sets in this problem, as revealed in tab.\ref{tab:2}. Note that I separate the locations from central location (depot) for clarity, but mix them in the following sections, because there is no major significance between them. An additional constraint "$y_l[7] == 1$" can do the job.
\begin{table}[ht]
    \centering
    \begin{tabular}{l l l}
        \hline
        \\[-1em]
        Set & Definition & Size \\
        \\[-1em]
        \hline
        \\[-1em]
        $L/d$ & locations and central location (depot) & 6+1\\
        \\[-1em]
        $S$ & Scenarios & 5 \\
        \\[-1em]
        $T$ & seasons & 4 \\
        \\[-1em]
        $K$ & customers & 12 \\
        \\[-1em]
        $F$ & forests & 10 \\
        \\[-1em]
        \hline
    \end{tabular}
    \caption{Categories of Sets and Their Attributes}
    \label{tab:2}
\end{table}
\FloatBarrier

The constraints are explained in tab.\ref{tab:3}. Note that I mix the locations and central location (depot) in the following questions.
\begin{table}[ht]
    \centering
    \small
    \begin{tabular}{l l l l}
        \hline
        \\[-1em]
        Constraint & Scope & Textual Representation & Number \\
        \\[-1em]
        \hline
        \\[-0.5em]
        \sum_{F} p_{l}^{s, t}(f) + \sum_{L/d} p_{l}^{s, t}(l') \leq HC_{l} \times y_1 & \forall s, l, t & \text{Handling Capacity of every $l$} & 6 \\
        \\[-0.5em]
        \sum_{F} p_{d}^{s, t}(f) + \sum_{L} p_{d}^{s, t}(l) \leq HC_{d} & \forall s, t & \text{Handling Capacity of $d$} & $1$ \\
        \\[-0.5em]
        h_{l}^{s, t} = h_{l}^{s, t-1} +\sum_{F} p_{l}^{s, t}(f) + \sum_{L/d} p_{l}^{s, t}(l') - \sum_{K} q_{l}^{s, t}(k) - \sum_{L/d} q_{l}^{s, t}(l') \leq SC_{l} \times y_1 & \forall s, l, t & \text{Storage Capacity} & 6 \\
        \\[-0.5em]
        h_{d}^{s, t} = h_{d}^{s, t-1} + \sum_{F} p_{d}^{s, t}(f) + \sum_{L} p_{d}^{s, t}(l) - \sum_{K} q_{d}^{s, t}(k) - \sum_{L} q_{d}^{s, t}(l) \leq SC_{d} & \forall s, t & \text{Storage Capacity of $d$} & $1$\\
        \\[-0.5em]
        h_{l}^{s, t} + \sum_{K} q_{l}^{s, t}(k) + \sum_{L/d} q_{l}^{s, t}(l') \leq \sum_{F} p_{l}^{s, t}(f) + \sum_{L/d} p_{l}^{s, t}(l') + h_{l}^{s, t-1} & \forall s, l, t & \text{Output $\leq$ Input + Storage} & $7 \times 4 \times 5$ \\
        \\[-0.5em]
        h_{d}^{s, t} + \sum_{K} q_{d}^{s, t}(k) + \sum_{L} q_{d}^{s, t}(l) \leq \sum_{F} p_{d}^{s, t}(f) + \sum_{L} p_{d}^{s, t}(l) + h_{d}^{s, t-1} & \forall s, t & \text{Output $\leq$ Input + Storage in $d$} & $4 \times 5$ \\
        \\[-0.5em]
        h_{l/d}^{s, t=0} = 0 & \forall s, l(d) & \text{Initial Storage = 0 of every $l$} & $7 \times 1 \times 5$ \\
        \\[-0.5em]
        q_{l}^{s, t}(l') = p_{l'}^{s, t}(l) & \forall u, l, s, t & \text{Exchange Equal} & $7 \times 7$ \\
        \\[-0.5em]
        0 \leq \sum_{L} p_{f}^{s, t}(l) \leq SL_{f}^{s, t} & \forall f, s, t & \text{Supply Limited} & 10 \\
        \\[-0.5em]
        \hline
    \end{tabular}
    \caption{Categories of Constraints and Their Attributes}
    \label{tab:3}
\end{table}
\FloatBarrier

There are parameters, as shown in tab.\ref{tab:4}.
\begin{table}[ht]
    \centering
    \begin{tabular}{l l l}
        \hline
        \\[-1em]
        Parameter & Definition & size \\
        \\[-1em]
        \hline
        \\[-1em]
        $\pi_s$ & probability of scenario $s$ & 5 \\
        \\[-1em]
        $c_{l/d}(f)$ & cost per ton from forest $f$ to location $l(d)$ & $7 \times 10$ \\
        \\[-1em]
        $c_{l/d}(k)$ & cost per ton from location $l(d)$ to customer $k$ to & $7 \times 12$ \\
        \\[-1em]
        $c_{l/d}(l')$ & cost per ton from location $l(d)$ to location $l'$ & $7 \times 7$ \\
        \\[-1em]
        $OPEN_l$ & opening cost of location $l$ & $6$ \\
        \\[-1em]
        $HC_{l/d}$ & handling capacity of location $l(d)$ & 7 \\
        \\[-1em]
        $SC_{l/d}$ & storage capacity of location $l(d)$ & 7 \\
        \\[-1em]
        $SL_{f}^{s, t}$ & supply limited of forest $f$ during season $t$ in senario $s$ & $10 \times 4 \times 5$ \\
        \\[-1em]
        \hline
    \end{tabular}
    \caption{Categories of Sets and Their Attributes}
    \label{tab:2}
\end{table}
\FloatBarrier

\subsection{Task 4, Question 2}

The Julia code used to solve the problem is displayed below. My family name is 'Xu', so I use the data from 'Data-Biomass-Task2-C.xlsx'.
\begin{lstlisting}
# DTU02435 Decision Making under Uncertainty
# Assignment 1, Task 4
# Edward J. Xu
# March 2nd, 2019
using JuMP
using GLPKMathProgInterface
using ExcelReaders

# ---------- 1. Constant ----------
num_s = 5
num_t = 4
num_l = 7
num_f = 10
num_k = 12
probs = [0.15 0.05 0.3 0.35 0.15]  # [Probability of scenarios]
cost = [942960 1199160 1247230 1031850 909680 1124690]  # [Cost of opening the location]
storageCapacity = [190 196 214 175 187 220 105]  # [Storage capacity of every location]
handlingCapacity = [460 484 556 400 448 580 420]  # [Handling capacity of every location]
supply = cat([185 132 167 133 197 179 172 148 193 185;
              125 138 144 147 111 138 156 146 146 157;
              94  123 112 88  115 104 92  90  98  87;
              121 127 159 145 129 137 179 153 142 136],
             [197 219 200 184 197 202 196 215 219 208;
              150 155 151 168 157 159 171 149 172 173;
              136 129 120 112 120 117 140 121 122 125;
              189 182 191 198 174 185 182 161 175 172],
             [215 231 186 218 208 203 215 230 216 208;
              162 159 150 189 189 159 184 185 153 161;
              124 154 135 137 138 144 120 139 123 128;
              219 189 205 192 211 210 170 185 207 188],
             [208 264 206 233 252 230 226 221 256 264;
              179 176 216 206 197 187 185 166 210 163;
              163 141 158 142 134 156 155 127 137 152;
              206 203 193 217 212 211 187 181 212 214],
             [253 306 256 297 263 288 265 305 243 271;
              202 248 205 208 211 218 220 235 236 218;
              164 160 190 171 158 191 159 195 187 163;
              258 260 263 235 266 223 225 276 270 263],
              dims = 3) # supply[t, f, s]
# Read excel data
file = openxl("/Users/fengguangjie/Desktop/Assignment 1/Data-Biomass-Task2-C.xlsx")
# Copy demand date from excel
data_demand = readxl(file, "CustomerDemand!C2:G49")
demand = zeros(num_k, num_t, num_s)
for s = 1: num_s
    for t = 1: num_t
        demand[:, t, s] = data_demand[num_k * (t-1) + 1: num_k * t, s]  # k-t-s
    end
end
# Copy fee date from excel
fee = readxl(file, "DistanceMatrix!B2:AD30")  # num_f + num_k + num_l
# 2. Define the model
m = Model(solver = GLPKSolverMIP())
# ---------- 2.1 Variables ----------
@variable(m, p[1: num_s, 1: num_t, 1: num_f, 1: num_l] >= 0)
@variable(m, q[1: num_s, 1: num_t, 1: num_l, 1: num_k] >= 0)
@variable(m, p_ul[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)
@variable(m, q_lv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)
@variable(m, 0 <= y[1: num_l] <= 1, Int)
@variable(m, offset[1: num_s, 1: num_t, 1: num_k] >= 0)
@variable(m, storage[1: num_s, 0: num_t, 1: num_l] >= 0)
# ---------- 2.2 Objective Function ----------
@objective(m, Min, sum([probs[s] * p[s, t, f, l] * fee[f, num_f + num_k + l] +
                        probs[s] * p_ul[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                        probs[s] * q[s, t, l, k] * fee[num_f + num_k + l, num_f + k] +
                        probs[s] * q_lv[s, t, l, v] * fee[num_f + num_k + l, num_f + num_k + v] for
                        s = 1: num_s, t = 1: num_t, f = 1: num_f,
                        l = 1: num_l, k = 1: num_k, u = 1: num_l, v = 1: num_l]) +
                   sum([probs[s] * 100000 * offset[s, t, k] for s = 1: num_s, t = 1: num_t, k = 1:num_k]) +
                   sum([y[l] * cost[l] for l = 1: num_l-1]))
# ---------- 2.3 Constraints ----------
@constraint(m, y[num_l] == 1)  # There is a central depot.
# Handling capacity
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l],
               sum(p[s, t, :, l]) + sum(p_ul[s, t, :, l]) <= handlingCapacity[l] * y[l])
# Storage capacity
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                storage[s, t-1, l] + sum(p[s, t, :, l]) + sum(p_ul[s, t, :, l])
                - sum(q[s, t, l, :]) - sum(q_lv[s, t, l, :]) <= storageCapacity[l] * y[l])
# Storage = Storage(t-1) - Output + Input
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                storage[s, t, l] == storage[s, t-1, l] + sum(p[s, t, :, l]) + sum(p_ul[s, t, :, l])
                - sum(q[s, t, l, :] - sum(q_lv[s, t, l, :])))
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], storage[s, t, l] == 0)
# Output <= Input + Storage
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                sum(q[s, t, l, :]) <= storage[s, t-1, l] + sum(p[s, t, :, l]))
# Supply limited
@constraint(m, [s = 1: num_s, t = 1: num_t, f = 1: num_f], sum(p[s, t, f, :]) <= supply[t, f, s])
# At least make up to meet the demand
@constraint(m, [s = 1: num_s, t = 1: num_t, k = 1: num_k], offset[s, t, k] >= 
                demand[k, t, s] - sum(q[s, t, :, k]))
# ---------- 3. Solve the model and show the outcome ----------
solution = solve(m)
\end{lstlisting}

The result is:
\begin{align}
    y &= [0.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0] \\
    obj &= 3.8 * 10^8 \\
    \text{offset[1,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    90.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &22.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0
    \end{bmatrix}
    }%
    \\ \text{offset[2,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    110.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &44.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0
    \end{bmatrix}
    }%
    \\ \text{offset[3,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    121.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &28.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0
    \end{bmatrix}
    }%
    \\ \text{offset[4,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    135.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &26.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0
    \end{bmatrix}
    }%
    \\ \text{offset[5,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    142.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 \\ 
    0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0 &0.0
    \end{bmatrix}
    }%
\end{align}

\subsection{Task 4, Question 4}

The process in an  can be illustrated in the fig.\ref{fig:dtu02435a1_1}. First column is the input into the location, and the third column is the output from the location. The process of making logs into chips and pellets are revealed in the middle column. Quantities regrading log or chips/pellets are separated into two rows. $h[t-1, l]$, $a[t-1, l]$ and $b[t-1, l]$ are storage of logs, chips and pellets from last seasons, with $h[0, l]$, $a[0, l]$ and $b[0, l]$ equals 0.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.6\linewidth]{images/dtu02435a1_1.png}
    \caption{Illustration of the Process in any Opened Location in the  Biomass Supply Chain}
    \label{fig:dtu02435a1_1}
\end{figure}
\FloatBarrier

There are cost $MAC$ to install a new machine in some location. The problem becomes:
\begin{align}
    \min \quad& \sum_{S} \pi_{s} \times \left\{\sum_{T} \left[\sum_{L} \sum_{F} pa_{l}^{s, t}(f) \times c_{l}(f) + \sum_{l} \sum_{l} (ph_{l}^{s, t}(l') + \sum_A pa_{l}^{s, t, a}(l')) \times c_{l}(l') + \right.\right. \\
    & \left.\left. \sum_{L} \sum_{K} \sum_A q_{l}^{s, t, a}(k) \times c_{l}(k) + \sum_{K} 100,000 \, (\sum_A x_{k}^{s, t, a}) \right] \right\} + \sum_{L} y_l \times OPEN_l + \sum_{L} z_{l} \times MAC - 15 \, MAC \\
    \text{s.t.} \quad& z_{l} \leq SPACE_{l} \quad \forall l \quad \text{(Space Limited)} \\
    \quad& \sum_{F} ph_{l}^{s, t}(f) + \sum_{l} ph_{l}^{s, t}(l') \leq HC_{l} \times y_1 \quad \forall s, l, t \quad \text{(Handling Capacity of every $l$)} \\
    & h_{l}^{s, t} = h_{l}^{s, t-1} +\sum_{F} ph_{L}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') - \sum_{l} qh_{l}^{s, t}(l') - \sum_A \frac{g_{l}^{s, t, a}}{EFF_a} \quad \forall s, t, l \\
    & a_{l}^{s, t, a} = a_{l}^{s, t-1, a} + \sum_{l} pa_{u, l}^{s, t, a}(l) + ga_{l}^{s, t, a} - \sum_{l} qa_{l, u}^{s, t, a} - \sum_{K} qa_{l, k}^{s, t, a} \quad \forall s, t, l, a \\
    & h_{l}^{s, t} + \sum_A a_{l}^{s, t, a} \leq SC_{l} \times y_1 \quad \forall s, l, t \quad \text{(Storage Capacity)} \\
    & h_{l}^{s, t} + \sum_{l} qh_{l}^{s, t}(l') + \frac{ga_{l}^{s, t}}{0.9} + \frac{gb_{l}^{s, t}}{0.95} \leq  h_{l}^{s, t-1} + \sum_{F} ph_{l}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') \quad \forall s, l, t \quad \text{(Output $\leq$ Input + Storage)} \\
    & a_{l}^{s, t} + \sum_{L} qa_{l}^{s, t, a}(l') + \sum_{K} qa_{l}^{s, t, a}(k) \leq a_{l}^{s, t-1} + \sum_{l} pa_{l}^{s, t, a}(l') + ga_{l}^{s, t, a} \quad \forall s, l, t, a \quad \text{(Output $\leq$ Input + Storage)} \\
    & h_{l}^{s, t=0}, a_{l}^{s, t=0, a} = 0 \quad \forall s, l, a \quad \text{(Initial Storage = 0)} \\
    & qa_{l}^{s, t, a}(l') = pa_{l'}^{s, t, a}(l) \quad \forall s, t, l, a \quad \text{(Exchange Equal)} \\
    & qh_{l}^{s, t}(l') = ph_{l'}^{s, t}(l) \quad \forall s, t, l \quad \text{(Exchange Equal)} \\
    & 0 \leq \sum_{L} p_{f}^{s, t}(l) \leq SL_{f}^{s, t} \quad \forall s, t, f  \quad \text{(Supply Limited)} \\
    & \sum_A \frac{ga_{l}^{s, t, a}}{EFF_a} \leq z_{l} \times ABILITY \quad \forall l, s, t \quad \text{(Process Ability Limited)} \\
    & \sum_A \frac{ga_{l}^{s, t, a}}{EFF_a} \leq h_{l}^{s, t-1} + \sum_{F} ph_{l}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') - \sum_{l} qh_{l}^{s, t}(l') - h_{l}^{s, t} \quad \forall s, t, l \quad \text{(Logs Limited)} \\
    & xa_{k}^{s, t, a} \geq Ka_{k}^{s, t, a} - \sum_{L} qa_{k}^{s, t, a}(l) \quad \forall s, t, k \quad \text{(At least make up to meet demand a)} \\
    & xa_{k}^{s, t, a} \geq 0 \quad \forall s, t, k, a \quad \text{(At least make up 0)} \\
    & y_l \in \{0, 1\} \quad \forall l \in \{1, 2, 3, 4, 5, 6, 7 \} \\
    & y_{7} = 1 \\
    & ph_{l}^{s, t}(f), qh_{l}^{s, t}(k), pa_{l}^{s, t, a}(f), qa_{l}^{s, t, a}(k) \geq 0 \quad \forall s, t, f, l, k \\
    & z_{d} \geq 15 \\
    & z_{l} \geq 0 \quad \forall l \\
    & z \in \mathbb{Z} \quad \forall l
\end{align}

There are some new variables. All the variables are shown in tab.\ref{tab:5}.
\begin{table}[ht]
    \centering
    \begin{tabular}{l l l l}
        \hline
        \\[-1em]
        Variable & Explain & Stage & Value Ranges \\
        \\[-1em]
        \hline
        \\[-1em]
        $y_l$ & whether open the $l$ location or not & first & ${0, 1}$ \\
        \\[-1em]
        $z_l$ & how many machines in $l$ & first & $\mathbb{Z} \cap [z_{\text{initial}}, z_{\text{max}}]$ \\
        \\[-1em]
        $ph_{l}^{s, t}(f)$ & input from forest $f$ to location $l$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $ph_{l}^{s, t}(l')$ & input from location $l'(d)$ to location $l$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $ga_{l}^{s, t, a}$ & processed $a$ from logs at location $l$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $qa_{l}^{s, t, a}(k)$ & output from location $l(d)$ to customer $k$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $qh_{l/d}^{s, t}(l')$ & output from location $l(d)$ to location $l'(d)$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $qa_{l/d}^{s, t, a}(l')$ & output $a$ from location $l(d)$ to location $l'(d)$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0}$ \\
        \\[-1em]
        $xa_{k}^{s, t, a}$ & supplement $a$ bought to meet customer $k$'s demand & second & $\mathbb{R}_{\geq 0} \cap (\geq K_{k}^{s, t} - \sum_{L} q_{k}^{s, t}(l)) $ \\
        \\[-1em]
        $h_{l}^{s, t}$ & storage in location $l$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0} \cap (\leq SC_{l}(h) \times y_1)$ \\
        \\[-1em]
        $a_{l}^{s, t, a}$ & storage of $a$ in location $l$ during $t$ season in scenario $s$ & second & $\mathbb{R}_{\geq 0} \cap (\leq SC_{l}(a) \times y_1)$ \\
        \\[-1em]
        \hline
    \end{tabular}
    \caption{Categories of Decision Variables and Their Attributes}
    \label{tab:5}
\end{table}
\FloatBarrier

There are some new constraints shown in tab.\ref{tab:6}.
\begin{table}[ht]
    \centering
    \small
    \begin{tabular}{l l l}
        \hline
        \\[-1em]
        Constraint & Scope & Textual Representation \\
        \\[-1em]
        \hline
        \\[-0.5em]
        $z_{l} \leq SPACE_{l}$ & $\forall l$ & Space Limited \\
        \\[-0.5em]
        $h_{l}^{s, t} = h_{l}^{s, t-1} +\sum_{F} ph_{L}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') - \sum_{l} qh_{l}^{s, t}(l') - \sum_A \frac{g_{l}^{s, t, a}}{EFF_a}$ & $\forall s, t, l$ \\
        \\[-0.5em]
        $a_{l}^{s, t, a} = a_{l}^{s, t-1, a} + \sum_{l} pa_{u, l}^{s, t, a}(l) + ga_{l}^{s, t, a} - \sum_{l} qa_{l, u}^{s, t, a} - \sum_{K} qa_{l, k}^{s, t, a}$ & $\forall s, t, l, a$ \\
        \\[-0.5em]
        $h_{l}^{s, t} + \sum_A a_{l}^{s, t, a} \leq SC_{l} \times y_1$ & $\forall s, l, t$ & Storage Capacity \\
        \\[-0.5em]
        $h_{l}^{s, t} + \sum_{l} qh_{l}^{s, t}(l') + \frac{ga_{l}^{s, t}}{0.9} + \frac{gb_{l}^{s, t}}{0.95} \leq  h_{l}^{s, t-1} + \sum_{F} ph_{l}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l')$ & $\forall s, l, t$ & Output $\leq$ Input + Storage \\
        \\[-0.5em]
        $a_{l}^{s, t} + \sum_{L} qa_{l}^{s, t, a}(l') + \sum_{K} qa_{l}^{s, t, a}(k) \leq a_{l}^{s, t-1} + \sum_{l} pa_{l}^{s, t, a}(l') + ga_{l}^{s, t, a}$ & $\forall s, l, t, a$ & Output $\leq$ Input + Storage \\
        \\[-0.5em]
        $qa_{l}^{s, t, a}(l') = pa_{l'}^{s, t, a}(l)$ & $\forall s, t, l, a$ & Exchange Equal \\
        \\[-0.5em]
        $\sum_A \frac{ga_{l}^{s, t, a}}{EFF_a} \leq z_{l} \times ABILITY$ & $\forall l, s, t$ & Process Ability Limited \\
        \\[-0.5em]
        $\sum_A \frac{ga_{l}^{s, t, a}}{EFF_a} \leq h_{l}^{s, t-1} + \sum_{F} ph_{l}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') - \sum_{l} qh_{l}^{s, t}(l') - h_{l}^{s, t}$ & $\forall s, t, l$ & Logs Limited \\
        \\[-0.5em]
        $xa_{k}^{s, t, a} \geq Ka_{k}^{s, t, a} - \sum_{L} qa_{k}^{s, t, a}(l)$ & $\forall s, t, k$ & At least make up to meet demand $a$ \\
        \\[-0.5em]
        $y_{7} = 1$ & & $d$ has been installed \\
        \\[-0.5em]
        $z_{d} \geq 15$ & & There has been 15 machines in $d$ \\
        \\[-0.5em]
        \hline
    \end{tabular}
    \caption{Categories of New Constraints and Their Attributes}
    \label{tab:3}
\end{table}
\FloatBarrier

The following Julia code is trying to solve the problem:
\begin{lstlisting}
# DTU02435 Decision Making under Uncertainty
# Assignment 1, Task 4, Part 2
# Edward J. Xu
# March 3nd, 2019
using JuMP
using GLPKMathProgInterface
using ExcelReaders

# ---------- 1. Constant ----------
num_s = 5
num_t = 4
num_l = 7
num_f = 10
num_k = 12
probs = [0.15 0.05 0.3 0.35 0.15]  # [Probability of scenarios]
cost = [942960 1199160 1247230 1031850 909680 1124690]  # [Cost of opening the location]
cost_machine = 11000  # [Cost of installing a machine]
ability = 70  # [Ability to process logs]
space = [6 5 11 7 9 10 20]  # [Maximum number of machines in the location]
storageCapacity = [190 196 214 175 187 220 105]  # [Storage capacity of every location]
handlingCapacity = [460 484 556 400 448 580 420]  # [Handling capacity of every location]
supply = cat([185 132 167 133 197 179 172 148 193 185;
              125 138 144 147 111 138 156 146 146 157;
              94  123 112 88  115 104 92  90  98  87;
              121 127 159 145 129 137 179 153 142 136],
             [197 219 200 184 197 202 196 215 219 208;
              150 155 151 168 157 159 171 149 172 173;
              136 129 120 112 120 117 140 121 122 125;
              189 182 191 198 174 185 182 161 175 172],
             [215 231 186 218 208 203 215 230 216 208;
              162 159 150 189 189 159 184 185 153 161;
              124 154 135 137 138 144 120 139 123 128;
              219 189 205 192 211 210 170 185 207 188],
             [208 264 206 233 252 230 226 221 256 264;
              179 176 216 206 197 187 185 166 210 163;
              163 141 158 142 134 156 155 127 137 152;
              206 203 193 217 212 211 187 181 212 214],
             [253 306 256 297 263 288 265 305 243 271;
              202 248 205 208 211 218 220 235 236 218;
              164 160 190 171 158 191 159 195 187 163;
              258 260 263 235 266 223 225 276 270 263],
              dims = 3) # supply[t, f, s]
# Read excel data
file = openxl("/Users/fengguangjie/Desktop/Assignment 1/Data-Biomass-Task4-C.xlsx")
# Copy demand date of chips and pellets from excel
data_demand_a = readxl(file, "CustomerDemand!C3:G50")
data_demand_b = readxl(file, "CustomerDemand!H3:L50")
demand_a = zeros(num_k, num_t, num_s)
demand_b = zeros(num_k, num_t, num_s)
for s = 1: num_s
    for t = 1: num_t
        demand_a[:, t, s] = data_demand_a[num_k * (t-1) + 1: num_k * t, s]  # k-t-s
        demand_b[:, t, s] = data_demand_b[num_k * (t-1) + 1: num_k * t, s]  # k-t-s
    end
end
# Copy fee date from excel
fee = readxl(file, "DistanceMatrix!B2:AD30")  # num_f + num_k + num_l
# 2. Define the model
m = Model(solver = GLPKSolverMIP())
# ---------- 2.1 Variables ----------
@variable(m, p_fl[1: num_s, 1: num_t, 1: num_f, 1: num_l] >= 0)  # [Logs transported from forests]
@variable(m, p_ul[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Logs transported from other locations]
@variable(m, p_a[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Chips transported from other locations]
@variable(m, p_b[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Pellets transported from other locations]
@variable(m, q_alk[1: num_s, 1: num_t, 1: num_l, 1: num_k] >= 0)  # [Chips transported to customers]
@variable(m, q_blk[1: num_s, 1: num_t, 1: num_l, 1: num_k] >= 0)  # [Pellets transported to customers]
@variable(m, q_lv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Logs transported to other locations]
@variable(m, q_alv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Chips transported to other locations]
@variable(m, q_blv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Pellets transported to other locations]
@variable(m, 0 <= y[1: num_l] <= 1, Int)  # [Whether open the location or not]
@variable(m, offset_a[1: num_s, 1: num_t, 1: num_k] >= 0)  # [Chips need to buy]
@variable(m, offset_b[1: num_s, 1: num_t, 1: num_k] >= 0)  # [Pellets need to buy]
@variable(m, h[1: num_s, 0: num_t, 1: num_l] >= 0)  # [Storage of logs]
@variable(m, a[1: num_s, 0: num_t, 1: num_l] >= 0)  # [Storage of chips]
@variable(m, b[1: num_s, 0: num_t, 1: num_l] >= 0)  # [Storage of pellets]
@variable(m, z[1: num_l] >= 0, Int)  # [Number of machines in each location]
@variable(m, g_a[1: num_s, 1: num_t, 1: num_l] >= 0)  # [Processed chips in each location]
@variable(m, g_b[1: num_s, 1: num_t, 1: num_l] >= 0)  # [Processed pellets in each location]
# ---------- 2.2 Objective Function ----------
@objective(m, Min,  sum([probs[s] * (p_fl[s, t, f, l] * fee[f, num_f + num_k + l] +
                                     p_ul[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                                     p_a[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                                     p_b[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                                     q_alk[s, t, l, k] * fee[num_f + num_k + l, num_f + k] +
                                     q_blk[s, t, l, k] * fee[num_f + num_k + l, num_f + k]) for
                        s = 1: num_s, t = 1: num_t, f = 1: num_f,
                        l = 1: num_l, k = 1: num_k, u = 1: num_l, v = 1: num_l]) +
                   sum([probs[s] * 100000 * (offset_a[s, t, k] + offset_b[s, t, k]) for
                       s = 1: num_s, t = 1: num_t, k = 1:num_k]) +
                   sum([y[l] * cost[l] for l = 1: num_l-1])) +
                   sum([z[l] * cost_machine for l = 1: num_l]) - 15 * cost_machine
# ---------- 2.3 Constraints ----------
@constraint(m, y[num_l] == 1)  # There is a central depot.
# Space limited
@constraint(m, [l = 1: num_l], z[l] <= space[l] * y[l])
@constraint(m, z[num_l] >= 15)  # There are 15 machines already installed in the depot.
# Handling capacity
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l],
               sum(p_fl[s, t, :, l]) + sum(p_ul[s, t, :, l]) <= handlingCapacity[l] * y[l])
# Storage capacity
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                h[s, t, l] + a[s, t, l] + b[s, t, l] <= storageCapacity[l] * y[l])
# Storage = Storage(t-1) - Output + Input
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                h[s, t, l] == h[s, t-1, l] + sum(p_fl[s, t, :, l]) + sum(p_ul[s, t, :, l])
                - g_a[s, t, l] / 0.9 - g_b[s, t, l] / 0.95 - sum(q_lv[s, t, l, :]))
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                a[s, t, l] == a[s, t-1, l] + sum(p_a[s, t, :, l]) + g_a[s, t, l]
                - sum(q_alk[s, t, l, :] - sum(q_alv[s, t, l, :])))
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                b[s, t, l] == b[s, t-1, l] + sum(p_b[s, t, :, l]) + g_b[s, t, l]
                - sum(q_blk[s, t, l, :] - sum(q_blv[s, t, l, :])))
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], h[s, t, l] == 0)
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], a[s, t, l] == 0)
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], b[s, t, l] == 0)
# Output <= Input + Storage
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                h[s, t, l] + g_a[s, t, l] / 0.9 + g_b[s, t, l] / 0.95 + sum(q_lv[s, t, l, :])
                <= h[s, t-1, l] + sum(p_fl[s, t, :, l]) + sum(p_fl[s, t, :, l]) + sum(p_ul[s, t, :, l]))
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                a[s, t, l] + sum(q_alk[s, t, l, :]) + sum(q_alv[s, t, l, :])
                <= a[s, t-1, l] + sum(p_a[s, t, :, l]) + g_a[s, t, l])
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                b[s, t, l] + sum(q_blk[s, t, l, :]) + sum(q_blv[s, t, l, :])
                <= b[s, t-1, l] + sum(p_b[s, t, :, l]) + g_b[s, t, l])
# p = q
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, v = 1: num_l],
                q_lv[s, t, l, v] == p_ul[s, t, v, l])
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, v = 1: num_l],
                q_alv[s, t, l, v] == p_a[s, t, v, l])
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, v = 1: num_l],
                q_blv[s, t, l, v] == p_b[s, t, v, l])
# Supply limited
@constraint(m, [s = 1: num_s, t = 1: num_t, f = 1: num_f], sum(p_fl[s, t, f, :]) <= supply[t, f, s])
# Process Ability limited
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l],
                g_a[s, t, l] / 0.9 + g_b[s, t, l] / 0.95 <= z[l] * ability)
# At least make up to meet the demand
@constraint(m, [s = 1: num_s, t = 1: num_t, k = 1: num_k], offset_a[s, t, k] >=
                demand_a[k, t, s] - sum(q_alk[s, t, :, k]))
@constraint(m, [s = 1: num_s, t = 1: num_t, k = 1: num_k], offset_b[s, t, k] >=
                demand_b[k, t, s] - sum(q_blk[s, t, :, k]))
# ---------- 3. Solve the model and show the outcome ----------
solution = solve(m)
\end{lstlisting}

The result is:
\begin{align}
    y &= [0.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0] \\
    z &= [0.0, 3.0, 7.0, 0.0, 6.0, 8.0, 15.0] \\
    obj &= 4.024 * 10^8 \\
    \text{offset-a[1,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    39 &0 &0 &0 &0 &0 &0 &0 &0 &0 &48 &49.88 \\ 
    34 &0 &0 &0 &0 &0 &0 &0 &0 &0 &34 &47 \\ 
    41 &0 &0 &0 &0 &0 &0 &0 &0 &0 &54 &52 \\
    62 &0 &0 &0 &0 &0 &0 &0 &0 &0 &72 &57
    \end{bmatrix}
    }%
    \\ 
    \text{offset-a[2,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    52 &0 &0 &0 &0 &0 &0 &0 &0 &0 &63 &60 \\ 
    51 &0 &0 &0 &0 &0 &0 &0 &0 &0 &49 &53 \\
    54 &0 &0 &0 &0 &0 &0 &0 &0 &0 &56 &11 \\ 
    79 &0 &0 &0 &0 &0 &0 &0 &0 &0 &79 &80
    \end{bmatrix}
    }%
    \\ 
    \text{offset-a[3,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    56 &0 &0 &0 &0 &0 &0 &0 &0 &0 &58 &50.73 \\
    48 &0 &0 &0 &0 &0 &0 &0 &0 &0 &49 &54 \\ 
    65 &0 &0 &0 &0 &0 &0 &0 &0 &0 &70 &66 \\ 
    86 &0 &0 &0 &0 &0 &0 &0 &0 &0 &88 &70
    \end{bmatrix}
    }%
    \\ 
    \text{offset-a[4,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    64 &0 &0 &0 &0 &0 &0 &0 &0 &0 &68 &66 \\ 
    56 &0 &0 &0 &0 &0 &0 &0 &0 &0 &53 &62 \\ 
    71 &0 &0 &0 &0 &0 &0 &0 &0 &0 &66 &0 \\ 
    85 &0 &0 &0 &0 &0 &0 &0 &0 &0 &90 &48
    \end{bmatrix}
    }%
    \\ 
    \text{offset-a[5,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    85 &0 &0 &0 &0 &0 &0 &0 &0 &0 &77 &5 \\ 
    77 &0 &0 &0 &0 &0 &0 &0 &0 &0 &65 &58.67 \\ 
    87 &0 &0 &0 &0 &0 &0 &0 &0 &0 &76 &75 \\ 
    88 &0 &0 &0 &0 &0 &0 &0 &0 &0 &88 &112
    \end{bmatrix}
    }%
    \\ 
    \text{offset-b[1,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    51 &0 &0 &0 &0 &0 &0 &0 &0 &0 &44 &0 \\ 
    47 &0 &0 &0 &0 &0 &0 &0 &0 &0 &42 &0 \\ 
    48 &0 &0 &0 &0 &0 &0 &0 &0 &0 &40 &0 \\ 
    58 &0 &0 &0 &0 &0 &0 &0 &0 &0 &64 &0
    \end{bmatrix}
    }%
    \\ 
    \text{offset-b[2,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    58 &0 &0 &0 &0 &0 &0 &0 &0 &0  &58 &0 \\ 
    47 &0 &0 &0 &0 &0 &0 &0 &0 &0  &48 &0 \\ 
    59 &0 &0 &0 &0 &0 &0 &0 &0 &0  &61 &0 \\ 
    76 &0 &0 &0 &0 &0 &0 &0 &0 &80 &0  &0
    \end{bmatrix}
    }%
    \\ 
    \text{offset-b[3,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    65 &0 &0 &0 &0 &0 &0 &0 &0 &0 &56 &0 \\ 
    54 &0 &0 &0 &0 &0 &0 &0 &0 &0 &51 &0 \\ 
    66 &0 &0 &0 &0 &0 &0 &0 &0 &0 &70 &0 \\ 
    71 &0 &0 &0 &0 &0 &0 &0 &0 &0 &87 &0
    \end{bmatrix}
    }%
    \\ 
    \text{offset-b[4,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    71 &0 &0 &0 &0 &0 &0 &0 &0 &0 &66 &0 \\ 
    64 &0 &0 &0 &0 &0 &0 &0 &0 &0 &66 &0 \\ 
    76 &0 &0 &0 &0 &0 &0 &0 &0 &0 &64 &0 \\ 
    77 &0 &0 &0 &0 &0 &0 &0 &0 &0 &82 &0
    \end{bmatrix}
    }%
    \\ 
    \text{offset-b[5,:,:]} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    89 &0 &0 &0 &0 &0 &0 &0 &0 &0 &79  &0 \\ 
    65 &0 &0 &0 &0 &0 &0 &0 &0 &0 &77  &0 \\ 
    89 &0 &0 &0 &0 &0 &0 &0 &0 &0 &72  &0 \\ 
    97 &0 &0 &0 &0 &0 &0 &0 &0 &0 &107 &0
    \end{bmatrix}
    }%
\end{align}

\subsection{Task 4, Question 5}

{
\begin{align}
    \min \quad& \sum_{S} \pi_{s} \times \left\{\sum_{T} \left[\sum_{L} \sum_{F} pa_{l}^{s, t}(f) \times c_{l}(f) + \sum_{l} \sum_{l} (ph_{l}^{s, t}(l') + \sum_A pa_{l}^{s, t, a}(l')) \times c_{l}(l') + \right.\right. \\
    & \left.\left. \sum_{L} \sum_{K} \sum_A q_{l}^{s, t, a}(k) \times c_{l}(k) + \sum_{K} 100,000 \, (\sum_A x_{k}^{s, t, a}) \right] + \sum_{L} y_{l}^{s} \times OPEN_l + \sum_{L} z_{l}^{s} \times MAC \right\} - 15 \, MAC \\
    \text{s.t.} \quad& z_{l}^{s} \leq SPACE_{l} \quad \forall l \quad \text{(Space Limited)} \\
    \quad& \sum_{F} ph_{l}^{s, t}(f) + \sum_{l} ph_{l}^{s, t}(l') \leq HC_{l} \times y_1 \quad \forall s, l, t \quad \text{(Handling Capacity of every $l$)} \\
    & h_{l}^{s, t} = h_{l}^{s, t-1} +\sum_{F} ph_{L}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') - \sum_{l} qh_{l}^{s, t}(l') - \sum_A \frac{g_{l}^{s, t, a}}{EFF_a} \quad \forall s, t, l \\
    & a_{l}^{s, t, a} = a_{l}^{s, t-1, a} + \sum_{l} pa_{u, l}^{s, t, a}(l) + ga_{l}^{s, t, a} - \sum_{l} qa_{l, u}^{s, t, a} - \sum_{K} qa_{l, k}^{s, t, a} \quad \forall s, t, l, a \\
    & h_{l}^{s, t} + \sum_A a_{l}^{s, t, a} \leq SC_{l} \times y_1 \quad \forall s, l, t \quad \text{(Storage Capacity)} \\
    & h_{l}^{s, t} + \sum_{l} qh_{l}^{s, t}(l') + \frac{ga_{l}^{s, t}}{0.9} + \frac{gb_{l}^{s, t}}{0.95} \leq  h_{l}^{s, t-1} + \sum_{F} ph_{l}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') \quad \forall s, l, t \quad \text{(Output $\leq$ Input + Storage)} \\
    & a_{l}^{s, t} + \sum_{L} qa_{l}^{s, t, a}(l') + \sum_{K} qa_{l}^{s, t, a}(k) \leq a_{l}^{s, t-1} + \sum_{l} pa_{l}^{s, t, a}(l') + ga_{l}^{s, t, a} \quad \forall s, l, t, a \quad \text{(Output $\leq$ Input + Storage)} \\
    & h_{l}^{s, t=0}, a_{l}^{s, t=0, a} = 0 \quad \forall s, l, a \quad \text{(Initial Storage = 0)} \\
    & qa_{l}^{s, t, a}(l') = pa_{l'}^{s, t, a}(l) \quad \forall s, t, l, a \quad \text{(Exchange Equal)} \\
    & qh_{l}^{s, t}(l') = ph_{l'}^{s, t}(l) \quad \forall s, t, l \quad \text{(Exchange Equal)} \\
    & 0 \leq \sum_{L} p_{f}^{s, t}(l) \leq SL_{f}^{s, t} \quad \forall s, t, f  \quad \text{(Supply Limited)} \\
    & \sum_A \frac{ga_{l}^{s, t, a}}{EFF_a} \leq z_{l}^{s} \times ABILITY \quad \forall l, s, t \quad \text{(Process Ability Limited)} \\
    & \sum_A \frac{ga_{l}^{s, t, a}}{EFF_a} \leq h_{l}^{s, t-1} + \sum_{F} ph_{l}^{s, t}(f) + \sum_{L} ph_{l}^{s, t}(l') - \sum_{l} qh_{l}^{s, t}(l') - h_{l}^{s, t} \quad \forall s, t, l \quad \text{(Logs Limited)} \\
    & xa_{k}^{s, t, a} \geq Ka_{k}^{s, t, a} - \sum_{L} qa_{k}^{s, t, a}(l) \quad \forall s, t, k \quad \text{(At least make up to meet demand a)} \\
    & xa_{k}^{s, t, a} \geq 0 \quad \forall s, t, k, a \quad \text{(At least make up 0)} \\
    & y_{l}^{s} \in \{0, 1\} \quad \forall l \in \{1, 2, 3, 4, 5, 6, 7 \} \\
    & y_{7}^{s} = 1 \quad \forall s \\
    & ph_{l}^{s, t}(f), qh_{l}^{s, t}(k), pa_{l}^{s, t, a}(f), qa_{l}^{s, t, a}(k) \geq 0 \quad \forall s, t, f, l, k \\
    & z_{d} \geq 15 \\
    & z_{l}^{s} \geq 0 \quad \forall l \\
    & z \in \mathbb{Z} \quad \forall l
\end{align}
}%

\begin{lstlisting}
# DTU02435 Decision Making under Uncertainty
# Assignment 1, Task 4, Part 5
# Optimization of biomass supply chain using expected value of perfect information
# Edward J. Xu
# March 3nd, 2019
using JuMP
using GLPKMathProgInterface
using ExcelReaders

# ---------- 1. Constant ----------
num_s = 5
num_t = 4
num_l = 7
num_f = 10
num_k = 12
probs = [0.15 0.05 0.3 0.35 0.15]  # [Probability of scenarios]
cost = [942960 1199160 1247230 1031850 909680 1124690]  # [Cost of opening the location]
cost_machine = 11000  # [Cost of installing a machine]
ability = 70  # [Ability to process logs]
space = [6 5 11 7 9 10 20]  # [Maximum number of machines in the location]
storageCapacity = [190 196 214 175 187 220 105]  # [Storage capacity of every location]
handlingCapacity = [460 484 556 400 448 580 420]  # [Handling capacity of every location]
supply = cat([185 132 167 133 197 179 172 148 193 185;
              125 138 144 147 111 138 156 146 146 157;
              94  123 112 88  115 104 92  90  98  87;
              121 127 159 145 129 137 179 153 142 136],
             [197 219 200 184 197 202 196 215 219 208;
              150 155 151 168 157 159 171 149 172 173;
              136 129 120 112 120 117 140 121 122 125;
              189 182 191 198 174 185 182 161 175 172],
             [215 231 186 218 208 203 215 230 216 208;
              162 159 150 189 189 159 184 185 153 161;
              124 154 135 137 138 144 120 139 123 128;
              219 189 205 192 211 210 170 185 207 188],
             [208 264 206 233 252 230 226 221 256 264;
              179 176 216 206 197 187 185 166 210 163;
              163 141 158 142 134 156 155 127 137 152;
              206 203 193 217 212 211 187 181 212 214],
             [253 306 256 297 263 288 265 305 243 271;
              202 248 205 208 211 218 220 235 236 218;
              164 160 190 171 158 191 159 195 187 163;
              258 260 263 235 266 223 225 276 270 263],
              dims = 3) # supply[t, f, s]
# Read excel data
file = openxl("/Users/fengguangjie/Desktop/Assignment 1/Data-Biomass-Task4-C.xlsx")
# Copy demand date of chips and pellets from excel
data_demand_a = readxl(file, "CustomerDemand!C3:G50")
data_demand_b = readxl(file, "CustomerDemand!H3:L50")
demand_a = zeros(num_k, num_t, num_s)
demand_b = zeros(num_k, num_t, num_s)
for s = 1: num_s
    for t = 1: num_t
        demand_a[:, t, s] = data_demand_a[num_k * (t-1) + 1: num_k * t, s]  # k-t-s
        demand_b[:, t, s] = data_demand_b[num_k * (t-1) + 1: num_k * t, s]  # k-t-s
    end
end
# Copy fee date from excel
fee = readxl(file, "DistanceMatrix!B2:AD30")  # num_f + num_k + num_l
# 2. Define the model
m = Model(solver = GLPKSolverMIP())
# ---------- 2.1 Variables ----------
@variable(m, p_fl[1: num_s, 1: num_t, 1: num_f, 1: num_l] >= 0)  # [Logs transported from forests]
@variable(m, p_ul[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Logs transported from other locations]
@variable(m, p_a[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Chips transported from other locations]
@variable(m, p_b[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Pellets transported from other locations]
@variable(m, q_alk[1: num_s, 1: num_t, 1: num_l, 1: num_k] >= 0)  # [Chips transported to customers]
@variable(m, q_blk[1: num_s, 1: num_t, 1: num_l, 1: num_k] >= 0)  # [Pellets transported to customers]
@variable(m, q_lv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Logs transported to other locations]
@variable(m, q_alv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Chips transported to other locations]
@variable(m, q_blv[1: num_s, 1: num_t, 1: num_l, 1: num_l] >= 0)  # [Pellets transported to other locations]
@variable(m, offset_a[1: num_s, 1: num_t, 1: num_k] >= 0)  # [Chips need to buy]
@variable(m, offset_b[1: num_s, 1: num_t, 1: num_k] >= 0)  # [Pellets need to buy]
@variable(m, h[1: num_s, 0: num_t, 1: num_l] >= 0)  # [Storage of logs]
@variable(m, a[1: num_s, 0: num_t, 1: num_l] >= 0)  # [Storage of chips]
@variable(m, b[1: num_s, 0: num_t, 1: num_l] >= 0)  # [Storage of pellets]
@variable(m, 0 <= y[1: num_s, 1: num_l] <= 1, Int)  # [Whether open the location or not]
@variable(m, z[1: num_s, 1: num_l] >= 0, Int)  # [Number of machines in each location]
@variable(m, g_a[1: num_s, 1: num_t, 1: num_l] >= 0)  # [Processed chips in each location]
@variable(m, g_b[1: num_s, 1: num_t, 1: num_l] >= 0)  # [Processed pellets in each location]
# ---------- 2.2 Objective Function ----------
@objective(m, Min, sum([probs[s] * (p_fl[s, t, f, l] * fee[f, num_f + num_k + l] +
                                    p_ul[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                                    p_a[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                                    p_b[s, t, u, l] * fee[num_f + num_k + u, num_f + num_k + l] +
                                    q_alk[s, t, l, k] * fee[num_f + num_k + l, num_f + k] +
                                    q_blk[s, t, l, k] * fee[num_f + num_k + l, num_f + k]) for
                        s = 1: num_s, t = 1: num_t, f = 1: num_f,
                        l = 1: num_l, k = 1: num_k, u = 1: num_l, v = 1: num_l]) +
                   sum([probs[s] * 100000 * (offset_a[s, t, k] + offset_b[s, t, k]) for
                       s = 1: num_s, t = 1: num_t, k = 1:num_k]) +
                   sum([probs[s] * y[s, l] * cost[l] for s = 1: num_s, l = 1: num_l-1])) +
                   sum([probs[s] * z[s, l] * cost_machine for s = 1: num_s, l = 1: num_l]) - 15 * cost_machine
# ---------- 2.3 Constraints ----------
@constraint(m, [s = 1: num_s], y[s, num_l] == 1)  # There is a central depot.
# Space limited
@constraint(m, [s = 1: num_s, l = 1: num_l], z[s, l] <= space[l] * y[s, l])
@constraint(m, [s = 1: num_s], z[s, num_l] >= 15)  # There are 15 machines already installed in the depot.
# Handling capacity
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l],
               sum(p_fl[s, t, :, l]) + sum(p_ul[s, t, :, l]) <= handlingCapacity[l] * y[s, l])
# Storage capacity
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                h[s, t, l] + a[s, t, l] + b[s, t, l] <= storageCapacity[l] * y[s, l])
# Storage = Storage(t-1) - Output + Input
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                h[s, t, l] == h[s, t-1, l] + sum(p_fl[s, t, :, l]) + sum(p_ul[s, t, :, l])
                - g_a[s, t, l] / 0.9 - g_b[s, t, l] / 0.95 - sum(q_lv[s, t, l, :]))
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                a[s, t, l] == a[s, t-1, l] + sum(p_a[s, t, :, l]) + g_a[s, t, l]
                - sum(q_alk[s, t, l, :] - sum(q_alv[s, t, l, :])))
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, f = 1: num_f, k = 1:num_k],
                b[s, t, l] == b[s, t-1, l] + sum(p_b[s, t, :, l]) + g_b[s, t, l]
                - sum(q_blk[s, t, l, :] - sum(q_blv[s, t, l, :])))
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], h[s, t, l] == 0)
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], a[s, t, l] == 0)
@constraint(m, [s = 1: num_s, t = 0, l = 1: num_l], b[s, t, l] == 0)
# Output <= Input + Storage
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                h[s, t, l] + g_a[s, t, l] / 0.9 + g_b[s, t, l] / 0.95 + sum(q_lv[s, t, l, :])
                <= h[s, t-1, l] + sum(p_fl[s, t, :, l]) + sum(p_fl[s, t, :, l]) + sum(p_ul[s, t, :, l]))
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                a[s, t, l] + sum(q_alk[s, t, l, :]) + sum(q_alv[s, t, l, :])
                <= a[s, t-1, l] + sum(p_a[s, t, :, l]) + g_a[s, t, l])
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, k = 1: num_k],
                b[s, t, l] + sum(q_blk[s, t, l, :]) + sum(q_blv[s, t, l, :])
                <= b[s, t-1, l] + sum(p_b[s, t, :, l]) + g_b[s, t, l])
# p = q
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, v = 1: num_l],
                q_lv[s, t, l, v] == p_ul[s, t, v, l])
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, v = 1: num_l],
                q_alv[s, t, l, v] == p_a[s, t, v, l])
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l, v = 1: num_l],
                q_blv[s, t, l, v] == p_b[s, t, v, l])
# Supply limited
@constraint(m, [s = 1: num_s, t = 1: num_t, f = 1: num_f], sum(p_fl[s, t, f, :]) <= supply[t, f, s])
# Process Ability limited
@constraint(m, [s = 1: num_s, t = 1: num_t, l = 1: num_l],
                g_a[s, t, l] / 0.9 + g_b[s, t, l] / 0.95 <= z[s, l] * ability)
# At least make up to meet the demand
@constraint(m, [s = 1: num_s, t = 1: num_t, k = 1: num_k], offset_a[s, t, k] >=
                demand_a[k, t, s] - sum(q_alk[s, t, :, k]))
@constraint(m, [s = 1: num_s, t = 1: num_t, k = 1: num_k], offset_b[s, t, k] >=
                demand_b[k, t, s] - sum(q_blk[s, t, :, k]))
# ---------- 3. Solve the model and show the outcome ----------
solution = solve(m)
\end{lstlisting}

\begin{align}
    \text{y} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    0.0 & 1.0 & 1.0 & 0.0 & 1.0 & 1.0 & 1.0 \\ 
    0.0 & 1.0 & 1.0 & 0.0 & 1.0 & 1.0 & 1.0 \\ 
    0.0 & 1.0 & 1.0 & 0.0 & 1.0 & 1.0 & 1.0 \\ 
    0.0 & 1.0 & 1.0 & 0.0 & 1.0 & 1.0 & 1.0 \\
    0.0 & 1.0 & 1.0 & 0.0 & 1.0 & 1.0 & 1.0
    \end{bmatrix}
    }%
    \\ \text{z} &= {
    \setcounter{MaxMatrixCols}{20}
    \begin{bmatrix}
    0.0 & 2.0 & 5.0 & 0.0 & 4.0 & 5.0 & 15.0 \\
    0.0 & 2.0 & 6.0 & 0.0 & 4.0 & 6.0 & 15.0 \\
    0.0 & 3.0 & 6.0 & 0.0 & 4.0 & 6.0 & 15.0 \\
    0.0 & 3.0 & 7.0 & 0.0 & 5.0 & 7.0 & 15.0 \\
    0.0 & 3.0 & 8.0 & 0.0 & 6.0 & 8.0 & 15.0
    \end{bmatrix}
    }%
\end{align}

\end{document}